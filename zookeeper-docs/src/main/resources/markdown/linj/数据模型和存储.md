# 待完善

###### **zookeeper 提供一种类似目录树结构的数据模型，每一个节点称之为znode。**


### znode 特性
- 每个 znode 的数据大小至多 1M
- znode 中的数据可以有多个版本，在查询该 znode 数据时就需要带上版本信息。
- znode 可以是临时 znode（create -e 生成的节点），一旦创建这个 znode 的 client 与
server 断开连接，该 znode 将被自动删除。client 和 server 之间通过 heartbeat 来确
认连接正常，这种状态称之为 session，断开连接后 session 失效。
- 临时 znode 不能有子 znode。
- znode 可以自动编号（create -s 生成的节点），例如在 create -s /app/node 已存在
时，将会生成 /app/node00***001 节点。
- **znode 可以被监控，该目录下某些信息的修改，例如节点数据、子节点变化等，可
以主动通知监控注册的 client。事实上，通过这个特性，可以完成许多重要应用，
例如配置管理、信息同步、分布式锁等等**。


## 相关class源码

### Znode节点类型定义类：org.apache.zookeeper.CreateMode 
**定义znode节点的7种类型：**

```
public enum CreateMode {
    /**
     * 永久节点，client断开连接，也不会自动删除
     */
    PERSISTENT (0, false, false, false, false),
    /**
     * 永久节点，序列化
     * client断开连接，不会自动删除，nodeName将添加一个单调递增的数字
    */
    PERSISTENT_SEQUENTIAL (2, false, true, false, false),
    /**
     * 临时节点，client断开连接，自动删除
     */
    EPHEMERAL (1, true, false, false, false),
    /**
     * 临时节点，client断开连接，自动删除，nodeName将添加一个单调递增的数字
     */
    EPHEMERAL_SEQUENTIAL (3, true, true, false, false),
    
    /**
     * 容器节点，特殊通途节点，例如 leader, lock 等
     * 当删除容器的最后一个子元素时，容器将成为将来某个时候服务器要删除的候选对象。
     */
    CONTAINER (4, false, false, true, false),
    /**
     * client 断开，znode不会自动删除
     * 但是，如果在给定的TTL中没有修改znode，那么一旦它没有子节点，它就会被删除（TTL: time of life 存活时间）
     */
    PERSISTENT_WITH_TTL(5, false, false, false, true),
    /**
     * 在客户端断开连接时，znode不会自动删除，它的名称将添加一个单调递增的数字。
     * 但是，如果在给定的TTL中没有修改znode，那么一旦它没有子节点，它就会被删除。
     */
    PERSISTENT_SEQUENTIAL_WITH_TTL(6, false, true, false, true);
}
```

### znode 元信息类: org.apache.zookeeper.data.Stat


```
public class Stat implements Record {
  private long czxid;//创建znode的zxid
  private long mzxid;//最新修改的 zxid
  private long ctime;//创建时间
  private long mtime;//修改时间
  private int version;//版本号，和 znode data 对应
  private int cversion;//版本号，和 child zndoe对应
  private int aversion;//版本号，和 acl对应
  private long ephemeralOwner;// 临时节点对应的client session id ，default：0
  private int dataLength; //znode data length
  private int numChildren;// children 的个数
  private long pzxid;//最新修改的zxid
}
```

### znode节点的所有信息类：org.apache.zookeeper.server.DataNode
**数据节点包含对其父节点的引用、作为其数据的字节数组、acl数组、stat对象及其子路径集**

- 需要注意的是children 存储的是路径名的最后部分

```
public class DataNode implements Record {
    //摘要值，由path、data and stat 计算得来，个人理解volatile修饰，用于做索引
    private volatile long digest;

    //指示此节点的摘要是否最新，用于优化性能
    volatile boolean digestCached;

    /** the data for this datanode */
    byte data[];

    /**
     * dataNode 的访问控制集合
     */
    Long acl;

    /**
     * 保存到磁盘的此节点的状态
     */
    public StatPersisted stat;

    /**
     * 此节点的子列表。注意，子字符串列表不包含父路径——只包含路径的最后一部分。
     */
    private Set<String> children = null;
}
```

## 维护整个目录树结构 : org.apache.zookeeper.server.DataTree

**zk数据存的核心类，该类维护两个并行的数据结构：**
1. 散列表
2. 数据节点树
